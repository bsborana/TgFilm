<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TG Movies â€” Premium OTT-Style</title>
  <meta name="theme-color" content="#0b0f14" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;
      --bg-soft:#121821;
      --text:#e6edf5;
      --muted:#9fb0c3;
      --accent:#00aefe; /* neon blue */
      --accent2:#ff0064; /* neon pink */
      --card:#131a23;
      --success:#19c37d;
      --danger:#ff4d4f;
      --shadow:0 10px 30px rgba(0,0,0,0.4);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b0f14 0%, #0e141b 100%);
      color:var(--text);
      font-family:Poppins, Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }
    a{color:var(--accent);text-decoration:none}
    img{display:block;max-width:100%}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(10,14,20,0.85) 0%, rgba(10,14,20,0.6) 100%);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .header-inner{
      display:grid;grid-template-columns:1fr 2.2fr 1fr;gap:14px;
      align-items:center;padding:12px 18px;max-width:1280px;margin:0 auto;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .brand-logo{
      width:42px;height:42px;border-radius:10px;
      background:radial-gradient(circle at 30% 20%, #00aefe 0%, #0b0f14 45%), radial-gradient(circle at 70% 80%, #ff0064 0%, #0b0f14 55%);
      box-shadow:0 0 18px rgba(0,174,255,0.65), 0 0 24px rgba(255,0,100,0.35);
    }
    .brand-text{
      line-height:1.1;
    }
    .brand-text .title{font-weight:700;letter-spacing:0.4px}
    .brand-text .tagline{font-size:12px;color:var(--muted)}
    .header-center{display:flex;justify-content:center}
    .searchbar{
      width:100%;max-width:640px;position:relative;
    }
    .searchbar input{
      width:100%;padding:14px 48px;border-radius:999px;border:1px solid rgba(255,255,255,0.14);
      background:rgba(18,24,33,0.9);color:var(--text);outline:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.05);
      transition:border-color .25s, box-shadow .25s, transform .2s;
    }
    .searchbar input:hover{box-shadow:0 0 12px rgba(0,174,255,0.25)}
    .searchbar input:focus{
      border-color:rgba(0,174,255,0.7);
      box-shadow:0 0 18px rgba(0,174,255,0.35), 0 0 22px rgba(255,0,100,0.25);
      transform:translateZ(0)
    }
    .search-icon{
      position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted)
    }
    .search-go{
      position:absolute;right:8px;top:50%;transform:translateY(-50%);
    }
    .btn{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);
      background:linear-gradient(180deg, #18202b 0%, #111821 100%);
      color:var(--text);cursor:pointer;transition:all .25s;
    }
    .btn:hover{
      box-shadow:0 0 15px rgba(255,0,100,0.8);
      transform:translateY(-1px);
    }
    .header-right{justify-self:end;font-size:13px;color:var(--muted)}

    /* Sections */
    main{max-width:1280px;margin:0 auto;padding:16px}
    section{margin:22px 0}
    h2{
      margin:6px 6px 14px; font-size:20px; font-weight:600; color:#cfe6ff;
      display:flex; align-items:center; gap:8px;
    }

    /* Hero carousel */
    .hero{
      position:relative;border-radius:18px;overflow:hidden;background:#0d1219;min-height:300px;
      box-shadow:var(--shadow);
    }
    .hero-slide{
      position:absolute;inset:0;display:none;
      background-position:center;background-size:cover;
      transition:opacity .6s ease;
    }
    .hero-slide.active{display:block;opacity:1}
    .hero-overlay{
      position:absolute;inset:0;
      background:linear-gradient(90deg, rgba(10,14,20,0.9) 0%, rgba(10,14,20,0.5) 45%, rgba(10,14,20,0.2) 100%),
                 radial-gradient(1200px 300px at 10% 90%, rgba(0,174,255,0.15) 0%, transparent 70%);
    }
    .hero-content{
      position:absolute;left:24px;bottom:20px;right:24px;
      display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap;
    }
    .hero-poster{
      width:160px;min-width:160px;border-radius:12px;overflow:hidden;
      box-shadow:0 0 22px rgba(0,174,255,0.35);
    }
    .hero-meta{max-width:680px}
    .hero-title{font-size:24px;font-weight:700;margin:0 0 6px}
    .hero-tag{color:var(--muted);margin-bottom:12px}
    .hero-actions{display:flex;gap:10px}
    .btn-primary{
      background:linear-gradient(180deg, #008fd3 0%, #056ba3 100%);
      border-color:rgba(255,255,255,0.18);
    }
    .btn-primary:hover{
      box-shadow:0 0 16px rgba(0,174,255,0.8);
    }

    /* Grids */
    .grid{
      display:grid;gap:14px;
      grid-template-columns:repeat(6, 1fr);
    }
    /* Responsive rules */
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(5,1fr)} }
    @media (max-width:820px){ .grid{grid-template-columns:repeat(3,1fr)} .header-inner{grid-template-columns:1fr} .header-right{display:none} }
    @media (max-width:640px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:480px){ .grid{grid-template-columns:repeat(2,1fr)} }

    /* Cards */
    .movie-card{
      background:linear-gradient(180deg, #131a23 0%, #0f141b 100%);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);overflow:hidden;position:relative;
      box-shadow:var(--shadow);transition:transform .25s, box-shadow .25s;
    }
    .movie-card:hover{transform:translateY(-3px);box-shadow:0 18px 36px rgba(0,0,0,0.55)}
    .poster-wrap{position:relative}
    .poster-wrap img{
      width:100%;aspect-ratio:2/3;object-fit:cover;
      transition:transform .3s ease, box-shadow .3s ease;
    }
    .poster-wrap img:hover{
      box-shadow:0 0 20px rgba(0,174,255,0.8);
      transform:scale(1.03);
    }
    .badge-new{
      position:absolute;top:10px;left:10px;padding:6px 10px;border-radius:999px;
      font-size:12px;background:rgba(255,0,100,0.9);color:white;box-shadow:0 0 12px rgba(255,0,100,0.7);
    }
    .card-body{padding:10px}
    .card-title{font-weight:600;margin:4px 0}
    .card-meta{font-size:12px;color:var(--muted)}
    .card-actions{padding:10px;display:flex;gap:8px}
    .btn-glow{
      background:linear-gradient(180deg, #1a202a 0%, #121821 100%);
      border-color:rgba(255,255,255,0.1);
    }
    .btn-glow:hover{box-shadow:0 0 15px rgba(255,0,100,0.8)}

    /* Player */
    #movie-player{
      display:none;position:relative;margin-top:12px;border-radius:18px;overflow:hidden;
      background:linear-gradient(180deg, #0c1118 0%, #111821 100%);
      border:1px solid rgba(255,255,255,0.08);box-shadow:var(--shadow);
      animation:fadeIn .4s ease forwards;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:none}}
    .player-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.06)}
    .player-title{font-weight:600}
    .player-meta{font-size:12px;color:var(--muted)}
    .player-close{
      cursor:pointer;font-size:24px;line-height:1;border:none;background:transparent;color:var(--muted);
      transition:color .2s, transform .2s;
    }
    .player-close:hover{color:#fff;transform:scale(1.08)}
    .player-wrap{position:relative;padding:10px}
    .player-iframe{
      width:100%;aspect-ratio:16/9;border:none;border-radius:12px;background:#000;
    }

    /* Skeleton loader */
    .skeleton{
      background:linear-gradient(90deg, rgba(200,210,220,0.07) 0%, rgba(200,210,220,0.18) 50%, rgba(200,210,220,0.07) 100%);
      background-size:200% 100%;animation:shimmer 1.2s linear infinite;
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* Toasts */
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#121821;border:1px solid rgba(255,255,255,0.12);color:#cfe6ff;padding:10px 14px;border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,0.45);z-index:99;display:none;
    }
    .toast.show{display:block;animation:fadeIn .2s ease}
    .toast.success{border-color:rgba(25,195,125,0.5)}
    .toast.error{border-color:rgba(255,77,79,0.5)}

    /* Request section */
    .request-box{
      display:grid;grid-template-columns:1.1fr 1.3fr;gap:14px;
      background:linear-gradient(180deg, #121821 0%, #0f141b 100%);
      border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:14px;
    }
    @media (max-width:820px){ .request-box{grid-template-columns:1fr} }
    .copy-row{display:flex;gap:8px}
    textarea{
      width:100%;min-height:100px;resize:vertical;padding:12px;border-radius:12px;
      background:#0f141b;color:var(--text);border:1px solid rgba(255,255,255,0.1);
    }
    .highlight{font-weight:600}

    /* Popup modal */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;z-index:100;
      background:rgba(0,0,0,0.55);
    }
    .modal.show{display:grid}
    .modal-card{
      width:92%;max-width:520px;background:#0f141b;border-radius:18px;border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 20px 50px rgba(0,0,0,0.6);padding:16px;
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center}
    .modal-actions{display:flex;gap:10px;margin-top:12px}
    .muted{color:var(--muted);font-size:14px}
    .footer{margin:28px 0 12px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-text">
          <div class="title">TG Movies</div>
          <div class="tagline">Premium OTT-style experience</div>
        </div>
      </div>

      <div class="header-center">
        <form id="global-search" class="searchbar" autocomplete="off">
          <span class="search-icon" aria-hidden="true">
            <!-- search icon -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15.5 15.5L20 20" stroke="#9fb0c3" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#9fb0c3" stroke-width="2"/></svg>
          </span>
          <input id="search-input" type="text" placeholder="Search movies (Doodstream + Poster fetch)" />
          <button id="search-go" class="btn btn-glow search-go" type="submit">Search</button>
        </form>
      </div>

      <div class="header-right">
        Latest updates auto-sync from Google Sheet
      </div>
    </div>
  </header>

  <main>
    <!-- Playback section -->
    <section id="movie-player">
      <div class="player-header">
        <div>
          <div class="player-title" id="player-title">â€”</div>
          <div class="player-meta" id="player-meta">â€”</div>
        </div>
        <button class="player-close" id="player-close" title="Close">Ã—</button>
      </div>
      <div class="player-wrap">
        <iframe id="player-iframe" class="player-iframe" allow="autoplay; fullscreen" referrerpolicy="no-referrer" loading="lazy"></iframe>
      </div>
    </section>

    <!-- Hero carousel -->
    <section>
      <h2>Hero carousel</h2>
      <div class="hero" id="hero">
        <!-- Slides injected here -->
      </div>
    </section>

    <!-- New movies (latest 5) -->
    <section>
      <h2>New movies</h2>
      <div class="grid" id="new-grid">
        <!-- Cards injected -->
      </div>
    </section>

    <!-- Recommended (rest beyond latest 5) -->
    <section>
      <h2>Recommended</h2>
      <div class="grid" id="rec-grid">
        <!-- Cards injected -->
      </div>
    </section>

    <!-- Search results (Doodstream + Poster fetch preview) -->
    <section>
      <h2>Search results</h2>
      <div class="grid" id="search-grid"></div>
      <div id="poster-tool" style="margin-top:14px">
        <div class="card-body" style="background:#111821;border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:14px">
          <div class="card-title">Poster fetch (TMDb/OMDb)</div>
          <div id="poster-result" style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap"></div>
        </div>
      </div>
    </section>

    <!-- Request section -->
    <section>
      <h2>Request</h2>
      <div class="request-box">
        <div>
          <p class="highlight">Bookmark this website to stay updated with the latest movies.</p>
          <p class="highlight">Submit your request with Movie Name, Language, and Year.</p>
          <a class="btn btn-primary" id="telegram-btn" href="https://t.me/your_group" target="_blank" rel="noopener">Open Telegram</a>
        </div>
        <div>
          <label for="req-format">Copy format</label>
          <textarea id="req-format">Request:
- Movie Name: [Enter]
- Language: [Enter]
- Year: [Enter]
          </textarea>
          <div class="copy-row">
            <button class="btn btn-glow" id="copy-request">Copy format</button>
            <button class="btn" id="clear-request">Clear</button>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">Â© 2025 TG Movies â€” All Rights Reserved</div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Popup modal -->
  <div id="install-modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 style="margin:0">Add TG Movies to your Home Screen or Bookmark it!</h3>
        <button class="player-close" id="modal-close" title="Close">Ã—</button>
      </div>
      <p class="muted">Get quick access and never miss the latest updates.</p>
      <div class="modal-actions">
        <button class="btn btn-primary" id="btn-install">Add to Home Screen</button>
        <button class="btn btn-glow" id="btn-bookmark">Add Bookmark</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== Config: replace placeholders ====== */
    const SHEET_ID = "{SHEET_ID}"; // e.g., 1AbCDEFgh... (Google Sheet ID)
    const DOODSTREAM_API_KEY = "{DOODSTREAM_API_KEY}";
    const OMDB_API_KEY = "{OMDB_API_KEY}"; // Optional: if using OMDb
    // If you prefer TMDb, you can add TMDB_API_KEY and adjust fetchPoster()

    /* ====== State ====== */
    let sheetMovies = []; // {title, year, language, genre, rating, posterUrl, embedLink, category, timestamp}
    let heroIndex = 0;
    let heroTimer = null;
    let deferredPrompt = null; // for PWA install

    /* ====== Utils ====== */
    function showToast(msg, type='info'){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast show ${type==='success'?'success':type==='error'?'error':''}`;
      setTimeout(()=>{ t.className='toast'; }, 2500);
    }
    function fmtMeta(m){
      return [m.year, m.language, m.genre, (m.rating ? 'â˜… '+m.rating : '')].filter(Boolean).join(' â€¢ ');
    }
    function smoothScrollToTop(){
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function isTodayDifferent(key){
      const last = localStorage.getItem(key);
      const today = new Date().toDateString();
      if(last !== today){ localStorage.setItem(key, today); return true; }
      return false;
    }

    /* ====== Google Sheet Integration ====== */
    async function fetchGoogleSheet(){
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
      try{
        const res = await fetch(url);
        const text = await res.text();
        const jsonStr = text.match(/(?<=google\.visualization\.Query\.setResponse\().*(?=\);)/s)[0];
        const data = JSON.parse(jsonStr);
        const cols = data.table.cols.map(c => c.label.trim());
        // Expect columns: Title | Year | Language | Genre | Rating | Poster URL | Embed Link | Category | Timestamp
        sheetMovies = data.table.rows.map(r => {
          const c = r.c;
          function val(i){ return c[i] ? (c[i].v ?? c[i].f ?? '') : ''; }
          return {
            title: String(val(cols.indexOf('Title')) || '').trim(),
            year: String(val(cols.indexOf('Year')) || '').trim(),
            language: String(val(cols.indexOf('Language')) || '').trim(),
            genre: String(val(cols.indexOf('Genre')) || '').trim(),
            rating: String(val(cols.indexOf('Rating')) || '').trim(),
            posterUrl: String(val(cols.indexOf('Poster URL')) || '').trim(),
            embedLink: String(val(cols.indexOf('Embed Link')) || '').trim(),
            category: String(val(cols.indexOf('Category')) || '').trim(),
            timestamp: String(val(cols.indexOf('Timestamp')) || '').trim(),
          };
        }).filter(m => m.title);

        // Sort latest first by Timestamp; fallback to original order
        sheetMovies.sort((a,b) => {
          const ta = new Date(a.timestamp).getTime();
          const tb = new Date(b.timestamp).getTime();
          if(!isNaN(ta) && !isNaN(tb)) return tb - ta;
          return 0;
        });

        renderFromSheet();
      }catch(err){
        console.error(err);
        showToast('Failed to load Google Sheet data', 'error');
      }
    }

    function renderFromSheet(){
      // Latest 10 for hero
      const latest10 = sheetMovies.slice(0,10);
      buildHero(latest10);
      // Latest 5 in New
      const latest5 = sheetMovies.slice(0,5);
      buildGrid(latest5, document.getElementById('new-grid'), { markNew:true });
      // Rest in Recommended
      const rest = sheetMovies.slice(5);
      buildGrid(rest, document.getElementById('rec-grid'), { markNew:false });
    }

    /* ====== Hero Carousel ====== */
    function buildHero(list){
      const hero = document.getElementById('hero');
      hero.innerHTML = '';
      list.forEach((m, idx) => {
        const slide = document.createElement('div');
        slide.className = 'hero-slide' + (idx===0 ? ' active' : '');
        slide.style.backgroundImage = `url('${m.posterUrl || ''}')`;
        slide.innerHTML = `
          <div class="hero-overlay"></div>
          <div class="hero-content">
            <div class="hero-poster">
              <img src="${m.posterUrl || ''}" alt="${m.title}" loading="lazy" />
            </div>
            <div class="hero-meta">
              <h3 class="hero-title">${m.title}</h3>
              <div class="hero-tag">${fmtMeta(m)}</div>
              <div class="hero-actions">
                <button class="btn btn-primary" data-play-idx="${idx}">Play</button>
              </div>
            </div>
          </div>
        `;
        hero.appendChild(slide);
      });

      // Play button listeners
      hero.querySelectorAll('[data-play-idx]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const idx = Number(e.currentTarget.getAttribute('data-play-idx'));
          playMovie(list[idx]);
        });
      });

      // Auto-rotate every 5s
      if(heroTimer) clearInterval(heroTimer);
      heroIndex = 0;
      heroTimer = setInterval(()=>{
        const slides = hero.querySelectorAll('.hero-slide');
        if(slides.length === 0) return;
        slides[heroIndex].classList.remove('active');
        heroIndex = (heroIndex + 1) % slides.length;
        slides[heroIndex].classList.add('active');
      }, 5000);
    }

    /* ====== Cards Grid ====== */
    function buildGrid(list, container, { markNew=false }={}){
      container.innerHTML = '';
      list.forEach((m, idx)=>{
        const card = document.createElement('div');
        card.className = 'movie-card';
        const badge = markNew ? `<span class="badge-new">NEW</span>` : '';
        card.innerHTML = `
          <div class="poster-wrap">
            ${badge}
            <img src="${m.posterUrl || ''}" alt="${m.title}" loading="lazy">
          </div>
          <div class="card-body">
            <div class="card-title">${m.title}</div>
            <div class="card-meta">${fmtMeta(m)}</div>
          </div>
          <div class="card-actions">
            <button class="btn btn-glow" data-play="${idx}">Play</button>
          </div>
        `;
        container.appendChild(card);
      });

      container.querySelectorAll('[data-play]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const i = Number(e.currentTarget.getAttribute('data-play'));
          playMovie(list[i]);
        });
      });
    }

    /* ====== Playback Section ====== */
    function playMovie(movie){
      const player = document.getElementById('movie-player');
      const titleEl = document.getElementById('player-title');
      const metaEl = document.getElementById('player-meta');
      const iframe = document.getElementById('player-iframe');

      titleEl.textContent = movie.title || 'Playing';
      metaEl.textContent = fmtMeta(movie);

      // Prefer embedLink from Sheet; if it's a Doodstream file code, convert; else use as-is
      let src = '';
      if(movie.embedLink){
        src = movie.embedLink;
      }else if(movie.file_code){
        src = `https://doodstream.com/e/${movie.file_code}`;
      }

      if(!src){
        showToast('No embed link available for this movie', 'error');
        return;
      }

      iframe.src = src;
      player.style.display = 'block';
      smoothScrollToTop();
      // Autoplay hint: some browsers require user gesture; doodstream should respect it after button click
    }

    document.getElementById('player-close').addEventListener('click', ()=>{
      const player = document.getElementById('movie-player');
      const iframe = document.getElementById('player-iframe');
      iframe.src = ''; // stop playback
      player.style.display = 'none';
    });

    /* ====== Doodstream API Search ====== */
    async function searchDoodstream(query){
      const url = `https://doodapi.com/api/file/list?key=${DOODSTREAM_API_KEY}&search=${encodeURIComponent(query)}`;
      const grid = document.getElementById('search-grid');
      grid.innerHTML = buildSkeletonCards(6);
      try{
        const res = await fetch(url);
        const json = await res.json();
        grid.innerHTML = '';

        if(!json || !Array.isArray(json.result) || json.result.length === 0){
          grid.innerHTML = '<div class="card-body" style="grid-column:1/-1;background:#111821;border-radius:12px;border:1px solid rgba(255,255,255,0.08)">No results found on Doodstream.</div>';
          return;
        }

        // Map to card-friendly structure
        const items = json.result.map(it => ({
          title: it.title,
          year: '', language: '', genre: '', rating: '',
          posterUrl: it.thumbnail || '',
          file_code: it.file_code,
          embedLink: `https://doodstream.com/e/${it.file_code}`,
        }));

        buildGrid(items, grid, { markNew:false });

        // Allow play from search
        grid.querySelectorAll('[data-play]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const idx = Number(e.currentTarget.getAttribute('data-play'));
            playMovie(items[idx]);
          });
        });

      }catch(err){
        console.error(err);
        showToast('Doodstream search failed', 'error');
        grid.innerHTML = '';
      }
    }

    /* ====== Poster Fetch Tool (OMDb sample) ====== */
    async function fetchPoster(title){
      const box = document.getElementById('poster-result');
      box.innerHTML = `<div class="skeleton" style="width:140px;height:210px;border-radius:12px"></div>
                       <div class="skeleton" style="width:60%;height:20px;border-radius:8px"></div>`;
      if(!OMDB_API_KEY || OMDB_API_KEY.includes('{OMDB_API_KEY}')){
        box.innerHTML = `<div class="muted">Configure OMDB_API_KEY to enable poster fetch.</div>`;
        return;
      }
      try{
        const url = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&t=${encodeURIComponent(title)}`;
        const res = await fetch(url);
        const data = await res.json();
        if(data && data.Poster && data.Poster !== 'N/A'){
          box.innerHTML = `
            <img src="${data.Poster}" alt="${data.Title}" style="width:140px;border-radius:12px;box-shadow:0 0 18px rgba(0,174,255,0.35)" loading="lazy">
            <div>
              <div class="card-title" style="margin:0 0 6px">${data.Title} (${data.Year || ''})</div>
              <div class="card-meta">IMDb: <a href="https://www.imdb.com/title/${data.imdbID}" target="_blank" rel="noopener">${data.imdbID}</a></div>
            </div>
          `;
        }else{
          box.innerHTML = `<div class="muted">No poster found for "${title}".</div>`;
        }
      }catch(err){
        console.error(err);
        showToast('Poster fetch failed', 'error');
        box.innerHTML = `<div class="muted">Error fetching poster.</div>`;
      }
    }

    /* ====== Skeleton cards ====== */
    function buildSkeletonCards(n=6){
      let html = '';
      for(let i=0;i<n;i++){
        html += `
          <div class="movie-card">
            <div class="poster-wrap">
              <div class="skeleton" style="width:100%;aspect-ratio:2/3"></div>
            </div>
            <div class="card-body">
              <div class="skeleton" style="width:70%;height:18px;border-radius:8px"></div>
              <div class="skeleton" style="width:50%;height:14px;border-radius:8px;margin-top:8px"></div>
            </div>
            <div class="card-actions">
              <div class="skeleton" style="width:80px;height:34px;border-radius:999px"></div>
            </div>
          </div>
        `;
      }
      return html;
    }

    /* ====== Popup System (daily) ====== */
    const installModal = document.getElementById('install-modal');
    const modalClose = document.getElementById('modal-close');
    const btnInstall = document.getElementById('btn-install');
    const btnBookmark = document.getElementById('btn-bookmark');

    function showInstallModal(){
      installModal.classList.add('show');
      setTimeout(()=>installModal.classList.remove('show'), 10000);
    }
    modalClose.addEventListener('click', ()=> installModal.classList.remove('show'));

    // PWA install capture
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
    });
    btnInstall.addEventListener('click', async ()=>{
      if(deferredPrompt){
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if(outcome === 'accepted') showToast('App installed', 'success');
        deferredPrompt = null;
      }else{
        showToast('Install prompt not available', 'error');
      }
    });

    // Bookmark handler
    btnBookmark.addEventListener('click', ()=>{
      try{
        // Attempt auto-bookmark (not widely supported). Fallback to instructions.
        showToast('Press Ctrl+D (Windows) or Cmd+D (Mac) to bookmark', 'success');
      }catch{
        showToast('Use Ctrl+D or Cmd+D to bookmark', 'success');
      }
    });

    /* ====== Request section actions ====== */
    document.getElementById('copy-request').addEventListener('click', async ()=>{
      const ta = document.getElementById('req-format');
      try{
        await navigator.clipboard.writeText(ta.value);
        showToast('âœ… Request format copied!', 'success');
      }catch{
        showToast('Copy failed. Select and copy manually.', 'error');
      }
    });
    document.getElementById('clear-request').addEventListener('click', ()=>{
      document.getElementById('req-format').value = '';
    });

    /* ====== Global search submit ====== */
    document.getElementById('global-search').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q = document.getElementById('search-input').value.trim();
      if(!q){ showToast('Type a movie name to search', 'error'); return; }
      // Search Doodstream and fetch poster in parallel
      searchDoodstream(q);
      fetchPoster(q);
    });

    /* ====== Init ====== */
    (function init(){
      fetchGoogleSheet();
      // Daily popup
      if(isTodayDifferent('tg_popup_day')){
        setTimeout(showInstallModal, 800);
      }
    })();
  </script>
</body>
</html>
