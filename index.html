<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sticky iframe — Immediate load, Window controls</title>
  <style>
    :root{
      --bar-height:92px;
      --accent:#ffb400;
      --z:99999;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#fff;color:#111;}
    main{min-height:100vh;padding:20px;}

    /* Sticky window container */
    .sticky-window{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      max-width:1320px;
      margin:0 auto;
      height:var(--bar-height);
      z-index:var(--z);
      transition:height .28s ease;
    }
    .window-frame{
      border-radius:10px;
      overflow:visible;
      box-shadow:0 8px 28px rgba(0,0,0,0.4);
      background:linear-gradient(180deg,#0b0b0b,#050505);
      color:#fff;
      border:1px solid rgba(255,255,255,0.04);
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .titlebar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      user-select:none;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    }
    .title{font-size:13px;color:#eaeaea;margin-right:auto;padding-left:6px;}
    .tbtn{width:36px;height:28px;border-radius:6px;border:0;background:rgba(255,255,255,0.04);color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .tbtn.primary{background:linear-gradient(90deg,var(--accent),#ff8a00);color:#111;font-weight:700}

    /* Content area that holds iframe */
    .content{
      height: calc(var(--bar-height) - 44px);
      transition:height .28s ease, transform .20s ease, opacity .18s ease;
      position:relative;
      overflow:hidden;
      background:#000;
    }

    /* iframe is always loaded but we hide/show content visually.
       When minimized we keep iframe rendered (so it's loaded) but moved/clipped out of view. */
    .ad-iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
      transform:translateY(0);
      transition:transform .28s ease, opacity .18s ease;
      will-change:transform,opacity;
    }

    /* MINIMIZED: only titlebar visible; content container height = 0, iframe visually translated up (hidden) but still loaded */
    .minimized .content{ height:0 !important; }
    .minimized .ad-iframe{ transform: translateY(-12px); opacity:0; pointer-events:none; }

    /* MAXIMIZED: make window taller to show full content */
    .maximized{ height:420px !important; }
    .maximized .content{ height: calc(420px - 44px) !important; }
    @media (max-width:900px){
      .maximized{ height:72vh !important; max-height:92vh; }
      .maximized .content{ height: calc(72vh - 44px) !important; }
      :root{ --bar-height:86px; }
    }

    /* Modal fallback for mobile */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:calc(var(--z)+10); display:flex; align-items:center; justify-content:center; visibility:hidden; opacity:0; transition:opacity .18s ease; }
    .modal.open{ visibility:visible; opacity:1; }
    .modal-inner{ width:100%; max-width:1100px; height:88vh; background:#000; border-radius:10px; overflow:hidden; display:flex; flex-direction:column; }
    .modal-top{ padding:8px 10px; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); color:#fff; }
    .modal-iframe{ flex:1 1 auto; width:100%; border:0; }
  </style>
</head>
<body>
  <main>
    <h2>Demo: Sticky iframe (Immediate load)</h2>
    <p>यहाँ page content है. नीचे वाला sticky window minimized/maximized behavior दिखाता है।</p>
    <div style="height:1400px;background:linear-gradient(#fff,#f3f3f3);margin-top:12px;border-radius:8px;"></div>
  </main>

  <!-- Sticky window -->
  <div id="stickyWindow" class="sticky-window" aria-label="Sticky ad window">
    <div id="windowFrame" class="window-frame">
      <div class="titlebar">
        <div class="title">Advertisement</div>
        <button id="minBtn" class="tbtn" title="Minimize" aria-pressed="false">—</button>
        <button id="maxBtn" class="tbtn" title="Maximize" aria-pressed="false">▢</button>
        <button id="openBtn" class="tbtn primary" title="Open in window">Open</button>
      </div>

      <div id="content" class="content" aria-hidden="false">
        <!-- iframe loads immediately -->
        <iframe id="adIframe" class="ad-iframe" title="Ad content"
          sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
          referrerpolicy="no-referrer"
          src="https://tangiblearroganceride.com/kxc8gqz5n?key=7ff75c4e196e2515c070ae6675694b6b"
        ></iframe>
      </div>
    </div>
  </div>

  <!-- Modal fallback -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-inner">
      <div class="modal-top">
        <div>Advertisement</div>
        <div style="display:flex;gap:8px">
          <button id="modalMin" class="tbtn">Min</button>
          <button id="modalClose" class="tbtn">Close</button>
        </div>
      </div>
      <iframe id="modalIframe" class="modal-iframe"
        sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
        referrerpolicy="no-referrer"
        src="https://tangiblearroganceride.com/kxc8gqz5n?key=7ff75c4e196e2515c070ae6675694b6b"
      ></iframe>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // Config
    const AD_URL = 'https://tangiblearroganceride.com/kxc8gqz5n?key=7ff75c4e196e2515c070ae6675694b6b';
    const RELOAD_MS = 90_000;

    // Elements
    const stickyWindow = document.getElementById('stickyWindow');
    const windowFrame = document.getElementById('windowFrame');
    const minBtn = document.getElementById('minBtn');
    const maxBtn = document.getElementById('maxBtn');
    const openBtn = document.getElementById('openBtn');
    const content = document.getElementById('content');
    const adIframe = document.getElementById('adIframe');

    const modal = document.getElementById('modal');
    const modalIframe = document.getElementById('modalIframe');
    const modalClose = document.getElementById('modalClose');
    const modalMin = document.getElementById('modalMin');

    // State
    let isMinimized = false;
    let isMaximized = false;
    let externalWin = null;
    let reloadTimer = null;

    function isMobile(){
      return /Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    }

    // Immediately loaded iframes: adIframe and modalIframe already have src preset in markup.
    // Start reload loop immediately (user asked content to be loaded even while minimized).
    function startReloadLoop(){
      stopReload();
      reloadTimer = setInterval(()=> {
        // Append timestamp to avoid cache
        try {
          const url = new URL(adIframe.src || AD_URL, location.href);
          url.searchParams.set('_ts', Date.now());
          adIframe.src = url.toString();
        } catch(e){
          adIframe.src = AD_URL + (AD_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        }

        try {
          const murl = new URL(modalIframe.src || AD_URL, location.href);
          murl.searchParams.set('_ts', Date.now());
          modalIframe.src = murl.toString();
        } catch(e){
          modalIframe.src = AD_URL + (AD_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        }
      }, RELOAD_MS);
    }
    function stopReload(){ if(reloadTimer){ clearInterval(reloadTimer); reloadTimer = null; } }

    // Start immediately
    startReloadLoop();

    // Minimize: only titlebar visible; content hidden visually but iframe remains loaded
    minBtn.addEventListener('click', ()=>{
      isMinimized = !isMinimized;
      if(isMinimized){
        windowFrame.classList.add('minimized');
        minBtn.setAttribute('aria-pressed','true');
      } else {
        windowFrame.classList.remove('minimized');
        minBtn.setAttribute('aria-pressed','false');
      }
    });

    // Maximize: expand height to show full content
    maxBtn.addEventListener('click', ()=>{
      isMaximized = !isMaximized;
      if(isMaximized){
        stickyWindow.classList.add('maximized');
        maxBtn.setAttribute('aria-pressed','true');
        // Ensure iframe has fully loaded src (it is already loaded). Optionally force a repaint:
        // reassign src to itself only to ensure any deferred content loads (rarely necessary)
        try {
          const u = new URL(adIframe.src || AD_URL, location.href);
          // do not append ts on maximize (avoid immediate reload) — keep as-is
          adIframe.src = u.toString();
        } catch(e){}
      } else {
        stickyWindow.classList.remove('maximized');
        maxBtn.setAttribute('aria-pressed','false');
      }
    });

    // Open behavior: desktop -> named window toggle; mobile -> modal open
    openBtn.addEventListener('click', ()=>{
      if(!isMobile()){
        const name = 'stickyAd_app_v1';
        if(!externalWin || externalWin.closed){
          externalWin = window.open(AD_URL, name, 'noopener,noreferrer,toolbar=yes,scrollbars=yes,resizable=yes,width=980,height=700');
          openBtn.textContent = 'Opened';
          openBtn.setAttribute('aria-pressed','true');
          const poll = setInterval(()=> {
            if(!externalWin || externalWin.closed){
              clearInterval(poll);
              externalWin = null;
              openBtn.textContent = 'Open';
              openBtn.setAttribute('aria-pressed','false');
            }
          },700);
        } else {
          try{ externalWin.close(); } catch(e){}
          externalWin = null;
          openBtn.textContent = 'Open';
          openBtn.setAttribute('aria-pressed','false');
        }
      } else {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
        // ensure modal iframe loaded (already has src)
        try {
          const url = new URL(modalIframe.src || AD_URL, location.href);
          // refresh modal iframe to latest if needed
          url.searchParams.set('_ts', Date.now());
          modalIframe.src = url.toString();
        } catch(e){
          modalIframe.src = AD_URL + (AD_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        }
      }
    });

    // Modal controls
    modalClose.addEventListener('click', ()=> {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    });
    modalMin.addEventListener('click', ()=> {
      // minimize modal: close modal and minimize sticky window (iframe already loaded)
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      if(!isMinimized){
        isMinimized = true;
        windowFrame.classList.add('minimized');
        minBtn.setAttribute('aria-pressed','true');
      }
    });
    modal.addEventListener('click',(ev)=>{ if(ev.target===modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } });

    // Keyboard accessibility
    document.addEventListener('keydown',(e)=>{
      if(e.key === 'Escape'){
        if(modal.classList.contains('open')){
          modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
        } else if(externalWin && !externalWin.closed){
          try{ externalWin.close(); } catch(e){}
          externalWin = null;
          openBtn.textContent = 'Open';
          openBtn.setAttribute('aria-pressed','false');
        } else if(stickyWindow.classList.contains('maximized')){
          stickyWindow.classList.remove('maximized');
          maxBtn.setAttribute('aria-pressed','false');
        }
      }
    });

    // Best-effort: close external window on page unload
    window.addEventListener('beforeunload', ()=> {
      try { if(externalWin && !externalWin.closed) externalWin.close(); } catch(e){}
    });

    // Expose small API
    window.StickyAdImmediate = {
      minimize(){ if(!isMinimized) minBtn.click(); },
      restore(){ if(isMinimized) minBtn.click(); },
      maximize(){ if(!isMaximized) maxBtn.click(); },
      unmaximize(){ if(isMaximized) maxBtn.click(); },
      openExternal(){ openBtn.click(); },
      forceReload(){ // immediate reload
        try {
          const url = new URL(adIframe.src || AD_URL, location.href);
          url.searchParams.set('_ts', Date.now());
          adIframe.src = url.toString();
        } catch(e){
          adIframe.src = AD_URL + (AD_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        }
      }
    };

  })();
  </script>
</body>
</html>
