<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TG Movies</title>
  <meta name="theme-color" content="#0b0f19" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f19;
      --bg-soft:#131a2b;
      --card:#161f34;
      --text:#e6e9ef;
      --muted:#a8b0c4;
      --accent:#00c2ff;
      --accent-2:#ff3366;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--accent); text-decoration:none}
    img{display:block; max-width:100%}
    .container{max-width:1200px; margin:0 auto; padding:0 16px}

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(11,15,25,.85) 0%, rgba(11,15,25,.65) 100%);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 0 rgba(255,255,255,.04);
    }
    .header-wrap{display:flex; align-items:center; gap:16px; padding:14px 0}
    .brand{display:flex; align-items:center; gap:12px; flex:0 0 auto}
    .logo{
      width:40px; height:40px; border-radius:10px;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      box-shadow: var(--shadow);
    }
    .brand-text{line-height:1}
    .brand-title{font-weight:600; letter-spacing:.4px}
    .brand-tag{font-size:12px; color:var(--muted)}
    .search-bar{
      flex:1; display:flex; align-items:center; gap:10px; position:relative;
    }
    .search-bar input{
      width:100%; padding:12px 16px; border-radius:999px; border:1px solid transparent;
      background:rgba(255,255,255,.06); color:var(--text);
      outline:none; transition:.25s; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .search-bar input::placeholder{color:#9aa3b8}
    .search-bar input:focus{box-shadow:0 0 0 2px rgba(0,194,255,.35); border-color:transparent}
    .search-btn{
      position:absolute; right:6px;
      padding:10px 16px; border:none; border-radius:999px;
      background:linear-gradient(135deg, var(--accent) 0%, #4df eff 100%);
      color:#04131a; font-weight:600; cursor:pointer; transition:.25s;
    }
    .search-btn:hover{transform:translateY(-1px);}

    /* Playback section */
    #movie-player{
      display:none; opacity:0; transform:translateY(-8px);
      transition:opacity .4s ease, transform .4s ease, height .4s ease;
      background:var(--bg-soft); border-bottom:1px solid rgba(255,255,255,.06);
    }
    #movie-player.active{display:block; opacity:1; transform:translateY(0);}
    .player-wrap{max-width:1200px; margin:0 auto; padding:16px}
    .player-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
    .player-meta{display:flex; flex-wrap:wrap; gap:12px; color:var(--muted); font-size:14px}
    .player-title{font-weight:600; font-size:18px; color:var(--text)}
    .player-close{
      background:transparent; border:none; color:var(--muted); font-size:24px; cursor:pointer; transition:.2s;
    }
    .player-close:hover{color:#fff}
    .player-iframe{
      position:relative; width:100%; aspect-ratio:16/9;
      border-radius:12px; overflow:hidden; background:#000; box-shadow:var(--shadow)
    }
    .player-iframe iframe{position:absolute; inset:0; width:100%; height:100%; border:0}

    /* Hero carousel */
    .hero{
      position:relative; height:46vh; min-height:340px; max-height:560px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, #0b0f19 0%, #0d1422 100%);
      overflow:hidden;
    }
    .hero-slide{
      position:absolute; inset:0; opacity:0; transition:opacity .6s ease;
      background-position:center; background-size:cover;
    }
    .hero-slide.active{opacity:1}
    .hero-overlay{
      position:absolute; inset:0; background:linear-gradient(180deg, rgba(7,10,18,.5) 0%, rgba(7,10,18,.85) 70%, rgba(7,10,18,1) 100%);
    }
    .hero-content{
      position:absolute; left:50%; bottom:30px; transform:translateX(-50%);
      width:min(1100px, 92%); display:flex; flex-direction:column; gap:10px;
    }
    .hero-title{font-size:24px; font-weight:600}
    .hero-tag{color:var(--muted)}
    .hero-actions{display:flex; gap:12px}
    .btn{
      padding:10px 16px; border:none; border-radius:999px; cursor:pointer; font-weight:600;
      transition:.25s; box-shadow:var(--shadow);
    }
    .btn-accent{
      background:linear-gradient(135deg, var(--accent) 0%, #4dfeff 100%);
      color:#05131a;
    }
    .btn-outline{
      background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18)
    }
    .btn:hover{transform:translateY(-1px)}

    /* Sections */
    section{padding:26px 0}
    .section-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:14px}
    .section-title{font-weight:600; font-size:20px}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(6, 1fr);
    }
    /* Responsive rules */
    @media (max-width:1280px){ .grid{grid-template-columns:repeat(5,1fr)}}
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(4,1fr)} .hero{height:44vh}}
    @media (max-width:820px){ .grid{grid-template-columns:repeat(3,1fr)} .hero{height:42vh}}
    @media (max-width:640px){ .grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:480px){ .grid{grid-template-columns:repeat(2,1fr)} .hero{height:38vh}}

    /* Card */
    .card{
      background:linear-gradient(180deg, var(--card) 0%, #12182a 100%);
      border-radius:14px; overflow:hidden; box-shadow: var(--shadow);
      transition: transform .25s, box-shadow .25s; position:relative;
    }
    .card:hover{transform:translateY(-4px)}
    .poster-wrap{position:relative}
    .poster-wrap img{width:100%; height:240px; object-fit:cover; background:#0a0d16}
    .badge-new{
      position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:600; color:#04131a; background:linear-gradient(135deg, var(--accent-2) 0%, #ff6a8e 100%); box-shadow: var(--shadow);
    }
    .card-body{padding:12px}
    .meta{display:flex; flex-wrap:wrap; gap:8px; color:var(--muted); font-size:12px; margin:8px 0}
    .title{font-size:15px; font-weight:600}
    .play-btn{
      width:100%; margin-top:10px; padding:10px 12px; border:none; border-radius:10px; cursor:pointer; font-weight:600;
      background:linear-gradient(135deg, var(--accent) 0%, #4dfeff 100%); color:#04131a; transition:.25s;
    }
    .play-btn:hover{transform:translateY(-1px)}

    /* Skeletons */
    .skeleton{
      position:relative; overflow:hidden; background:#12182a; border-radius:12px;
    }
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.08) 50%, rgba(255,255,255,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{0%{transform:translateX(-100%)} 100%{transform:translateX(100%)}}

    /* Request section */
    .request-box{
      background:var(--bg-soft); border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:16px; display:flex; flex-direction:column; gap:12px;
    }
    .flex-row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .textarea{
      width:100%; min-height:100px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:#0d1424; color:var(--text); outline:none
    }
    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:#0d182b; color:#d8e4ff; padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:.3s;
    }
    .toast.show{opacity:1}

    /* Popup modal */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100;
      background:rgba(0,0,0,.5)
    }
    .modal.active{display:flex}
    .modal-card{
      width:min(560px, 92%); background:var(--bg-soft); border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:18px; box-shadow:var(--shadow)
    }
    .modal-actions{display:flex; gap:10px; margin-top:10px}
    .modal-note{color:var(--muted); font-size:13px}

    /* Footer */
    footer{
      padding:22px 0; text-align:center; color:var(--muted); border-top:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, #0d1422 0%, #0b0f19 100%);
    }

    /* Helper badges */
    .chip{padding:4px 8px; border-radius:999px; font-size:12px; background:#0f172a; border:1px solid rgba(255,255,255,.12); color:#cbd5e1}
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="container header-wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brand-text">
          <div class="brand-title">TG Movies</div>
          <div class="brand-tag">Premium OTT-style experience</div>
        </div>
      </div>
      <div class="search-bar">
        <input id="globalSearch" type="text" placeholder="Search movies on Doodstream..." aria-label="Search" />
        <button id="searchBtn" class="search-btn">Search</button>
      </div>
    </div>
  </header>

  <!-- Playback Section (hidden by default) -->
  <section id="movie-player">
    <div class="player-wrap">
      <div class="player-header">
        <div>
          <div class="player-title" id="playerTitle">Playing...</div>
          <div class="player-meta" id="playerMeta">
            <span class="chip" id="metaYear"></span>
            <span class="chip" id="metaLang"></span>
            <span class="chip" id="metaGenre"></span>
            <span class="chip" id="metaRating"></span>
          </div>
        </div>
        <button class="player-close" id="playerClose" title="Close">Ã—</button>
      </div>
      <div class="player-iframe">
        <iframe id="playerIframe" allow="autoplay; fullscreen" referrerpolicy="no-referrer" allowfullscreen></iframe>
      </div>
    </div>
  </section>

  <!-- Hero Carousel -->
  <section class="hero" id="hero">
    <!-- Slides injected dynamically -->
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="hero-title" id="heroTitle">Discover the latest arrivals</div>
      <div class="hero-tag">Handpicked, auto-updated from Google Sheet</div>
      <div class="hero-actions">
        <button class="btn btn-accent" id="heroPlay">Play</button>
        <button class="btn btn-outline" id="heroMore">Explore</button>
      </div>
    </div>
  </section>

  <!-- New Movies -->
  <section class="container">
    <div class="section-head">
      <div class="section-title">New movies</div>
      <div class="chip">Latest 5</div>
    </div>
    <div id="newGrid" class="grid">
      <!-- Skeletons -->
    </div>
  </section>

  <!-- Recommended Movies -->
  <section class="container">
    <div class="section-head">
      <div class="section-title">Recommended</div>
      <div class="chip">From your library</div>
    </div>
    <div id="recGrid" class="grid">
      <!-- Skeletons -->
    </div>
  </section>

  <!-- IMDb Poster Fetch Tool -->
  <section class="container">
    <div class="section-head">
      <div class="section-title">IMDb poster fetch</div>
      <div class="chip">via TMDb</div>
    </div>
    <div class="request-box">
      <div class="flex-row">
        <input id="imdbIdInput" class="textarea" style="min-height:unset" placeholder="Enter IMDb ID (e.g., tt4154796)" />
        <button id="imdbFetchBtn" class="btn btn-accent">Fetch poster</button>
      </div>
      <div id="imdbResult" style="display:grid; grid-template-columns: 160px 1fr; gap:14px;">
        <div id="imdbPoster" class="skeleton" style="height:240px; border-radius:12px;"></div>
        <div id="imdbInfo">
          <div id="imdbTitle" class="title"></div>
          <div style="margin-top:6px">
            <a id="imdbLink" href="#" target="_blank" class="chip" style="display:inline-block; margin-right:6px; opacity:.0; pointer-events:none">IMDb</a>
            <a id="tmdbLink" href="#" target="_blank" class="chip" style="display:inline-block; opacity:.0; pointer-events:none">TMDb</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Request Section -->
  <section class="container">
    <div class="section-head">
      <div class="section-title">Request a movie</div>
      <div class="chip">Telegram + format</div>
    </div>
    <div class="request-box">
      <div><strong>Instructions:</strong> Fill the details exactly like below and send in Telegram.</div>
      <textarea id="requestFormat" class="textarea" readonly>Movie Name: 
Language:
Year:
Links (optional):</textarea>
      <div class="flex-row">
        <button id="copyFormat" class="btn btn-outline">Copy format</button>
        <a id="tgBtn" class="btn btn-accent" href="https://t.me/your_group_here" target="_blank" rel="noopener">Open Telegram</a>
      </div>
      <div style="margin-top:6px; font-weight:600;">
        ðŸ‘‰ <strong>Is website ko bookmark me add kar lo taaki aap hamesha latest movies dekh sako.</strong>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    Â© 2025 TG Movies â€” All Rights Reserved
  </footer>

  <!-- Popup Modal -->
  <div id="popupModal" class="modal" role="dialog" aria-modal="true" aria-label="Bookmark prompt">
    <div class="modal-card">
      <div class="title" style="margin-bottom:6px">Stay updated</div>
      <div style="color:var(--muted); margin-bottom:10px;">
        ðŸ‘‰ Is website ko apne Home Screen par add karo ya Bookmark karo taaki aap hamesha latest movies dekh sako.
      </div>
      <div class="modal-actions">
        <button id="installPWA" class="btn btn-accent">Add to Home Screen</button>
        <button id="bookmarkSite" class="btn btn-outline">Bookmark Website</button>
        <button id="dismissModal" class="btn btn-outline">Dismiss</button>
      </div>
      <div class="modal-note" style="margin-top:8px">Popup will auto-close in 10s.</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">âœ… Request format copied!</div>

  <script>
    /* ====== CONFIG: replace placeholders ====== */
    const CONFIG = {
      GOOGLE_SHEET_ID: "{SHEET_ID}", // e.g., 1AbCdEFg... (do NOT include /edit)
      DOODSTREAM_API_KEY: "{DOODSTREAM_API_KEY}",
      TMDB_API_KEY: "{83cc5358fefe8b5ffb79b0ba491fd1a3}", // Required for IMDb â†’ TMDb poster
      TELEGRAM_GROUP_URL: "https://t.me/your_group_here"
    };

    /* ====== State ====== */
    const state = {
      sheetMovies: [],      // raw movies from sheet
      heroMovies: [],       // latest 10
      newMovies: [],        // latest 5
      recMovies: [],        // rest
      heroIndex: 0,
      heroTimer: null,
      deferredPrompt: null  // for PWA install
    };

    /* ====== Utilities ====== */
    const qs = (sel, root=document) => root.querySelector(sel);
    const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const create = (tag, props={}) => Object.assign(document.createElement(tag), props);

    const showToast = (msg="âœ… Request format copied!", timeout=2200) => {
      const toast = qs("#toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), timeout);
    };

    const smoothScrollTop = () => window.scrollTo({top:0, behavior:"smooth"});

    const parseGVizJSON = (text) => {
      // Remove "google.visualization.Query.setResponse(...)" wrapper
      const jsonStr = text.replace(/^[^{]+/, "").replace(/;?$/, "");
      return JSON.parse(jsonStr);
    };

    const toMovieObj = (row) => {
      const cells = row.c || [];
      const val = i => cells[i]?.v ?? "";
      return {
        title: String(val(0)).trim(),
        year: String(val(1)).trim(),
        language: String(val(2)).trim(),
        genre: String(val(3)).trim(),
        rating: String(val(4)).trim(),
        poster: String(val(5)).trim(),
        embed: String(val(6)).trim(),
        category: String(val(7)).trim(),
        timestamp: String(val(8)).trim()
      };
    };

    const buildCard = (movie, isNew=false) => {
      const card = create("div", {className:"card"});
      const posterWrap = create("div", {className:"poster-wrap"});
      const img = create("img", {alt: movie.title || "Poster", loading:"lazy"});
      img.src = movie.poster || "";
      posterWrap.appendChild(img);
      if(isNew){
        posterWrap.appendChild(create("div", {className:"badge-new", textContent:"NEW"}));
      }
      const body = create("div", {className:"card-body"});
      const title = create("div", {className:"title", textContent: movie.title});
      const meta = create("div", {className:"meta"});
      meta.innerHTML = `
        <span><strong>Year:</strong> ${movie.year || "-"}</span>
        <span><strong>Language:</strong> ${movie.language || "-"}</span>
        <span><strong>Genre:</strong> ${movie.genre || "-"}</span>
        <span><strong>Rating:</strong> ${movie.rating || "-"}</span>
      `;
      const playBtn = create("button", {className:"play-btn", textContent:"Play"});
      playBtn.addEventListener("click", () => playMovie(movie));
      body.append(title, meta, playBtn);
      card.append(posterWrap, body);
      return card;
    };

    const setPlayer = (movie, embedUrl) => {
      qs("#playerTitle").textContent = movie?.title || "Playing...";
      qs("#metaYear").textContent = movie?.year ? `Year: ${movie.year}` : "";
      qs("#metaLang").textContent = movie?.language ? `Lang: ${movie.language}` : "";
      qs("#metaGenre").textContent = movie?.genre ? `Genre: ${movie.genre}` : "";
      qs("#metaRating").textContent = movie?.rating ? `Rating: ${movie.rating}` : "";

      const iframe = qs("#playerIframe");
      iframe.src = embedUrl || "";
      const section = qs("#movie-player");
      section.classList.add("active");
      smoothScrollTop();
    };

    const closePlayer = () => {
      const section = qs("#movie-player");
      const iframe = qs("#playerIframe");
      iframe.src = ""; // stop playback
      section.classList.remove("active");
    };

    /* ====== Google Sheet Integration ====== */
    async function fetchSheetMovies(){
      const url = `https://docs.google.com/spreadsheets/d/${CONFIG.GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json`;
      const newGrid = qs("#newGrid");
      const recGrid = qs("#recGrid");

      // Skeletons
      const skel = () => {
        const s = create("div", {className:"skeleton"});
        s.style.height = "300px";
        return s;
      };
      newGrid.innerHTML = ""; recGrid.innerHTML = "";
      for(let i=0;i<5;i++) newGrid.appendChild(skel());
      for(let i=0;i<8;i++) recGrid.appendChild(skel());

      try{
        const resp = await fetch(url, {cache:"no-store"});
        const text = await resp.text();
        const json = parseGVizJSON(text);
        const rows = json.table?.rows || [];
        const movies = rows.map(toMovieObj)
          .filter(m => m.title && (m.embed || m.poster)); // basic validity

        // Sort latest first by timestamp or by order (assuming last rows are latest)
        const sorted = movies.slice().sort((a,b)=>{
          const ta = Date.parse(a.timestamp) || 0;
          const tb = Date.parse(b.timestamp) || 0;
          if(ta && tb) return tb - ta;
          // fallback: keep original order but reverse (latest last row first)
          return 0;
        });

        state.sheetMovies = sorted.length ? sorted : movies.reverse();

        // Partition
        state.newMovies = state.sheetMovies.slice(0,5);
        state.recMovies = state.sheetMovies.slice(5);
        state.heroMovies = state.sheetMovies.slice(0,10);

        renderSheetSections();
        renderHero();

      }catch(err){
        console.error("Sheet fetch failed", err);
        newGrid.innerHTML = `<div class="chip">No results found from Google Sheet.</div>`;
        recGrid.innerHTML = `<div class="chip">Please check your Sheet ID.</div>`;
      }
    }

    function renderSheetSections(){
      const newGrid = qs("#newGrid");
      const recGrid = qs("#recGrid");
      newGrid.innerHTML = "";
      recGrid.innerHTML = "";

      state.newMovies.forEach(m => newGrid.appendChild(buildCard(m, true)));
      state.recMovies.forEach(m => recGrid.appendChild(buildCard(m, false)));
    }

    /* ====== Hero Carousel ====== */
    function renderHero(){
      const hero = qs("#hero");
      // clear existing slides
      qsa(".hero-slide", hero).forEach(el => el.remove());

      state.heroMovies.forEach((m, idx) => {
        const slide = create("div", {className:"hero-slide"});
        const bgImg = m.poster || "";
        slide.style.backgroundImage = bgImg ? `url('${bgImg}')` : "linear-gradient(180deg,#0b0f19,#0d1422)";
        slide.dataset.index = String(idx);
        hero.appendChild(slide);
      });

      state.heroIndex = 0;
      updateHeroContent();
      cycleHero();
    }

    function updateHeroContent(){
      const slides = qsa(".hero-slide", qs("#hero"));
      slides.forEach(s => s.classList.remove("active"));
      if(!slides.length) return;
      const idx = state.heroIndex % slides.length;
      slides[idx].classList.add("active");

      const movie = state.heroMovies[idx] || {title:"Discover the latest arrivals", tagline:""};
      qs("#heroTitle").textContent = movie.title || "Discover the latest arrivals";

      // Wire hero play button
      qs("#heroPlay").onclick = () => playMovie(movie);
      // "Explore" scrolls to New Movies
      qs("#heroMore").onclick = () => qs("#newGrid").scrollIntoView({behavior:"smooth", block:"start"});
    }

    function cycleHero(){
      if(state.heroTimer) clearInterval(state.heroTimer);
      state.heroTimer = setInterval(()=>{
        state.heroIndex = (state.heroIndex + 1) % Math.max(state.heroMovies.length, 1);
        updateHeroContent();
      }, 5000);
    }

    /* ====== Playback ====== */
    function playMovie(movie){
      // Prefer movie.embed; if empty, no-op
      let embed = movie.embed || "";
      // Ensure Doodstream embed uses /e/file_code
      if(embed && /doodstream\.com/.test(embed) && !/\/e\//.test(embed)){
        const codeMatch = embed.match(/([a-zA-Z0-9]{6,})$/);
        if(codeMatch) embed = `https://doodstream.com/e/${codeMatch[1]}`;
      }
      setPlayer(movie, embed);
    }
    qs("#playerClose").addEventListener("click", closePlayer);

    /* ====== Doodstream API Search ====== */
    async function searchDoodstream(query){
      const gridNew = qs("#newGrid");
      const gridRec = qs("#recGrid");
      // show skeleton over recommended grid for search results
      gridRec.innerHTML = "";
      for(let i=0;i<8;i++){
        const s = create("div", {className:"skeleton"}); s.style.height="300px"; gridRec.appendChild(s);
      }

      try{
        const url = `https://doodapi.com/api/file/list?key=${encodeURIComponent(CONFIG.DOODSTREAM_API_KEY)}&search=${encodeURIComponent(query)}`;
        const res = await fetch(url, {cache:"no-store"});
        const data = await res.json();

        // On failure or empty, fallback to sheet sections
        if(!data || !Array.isArray(data.result) || !data.result.length){
          gridRec.innerHTML = `<div class="chip">No results found on Doodstream. Showing recommended from Google Sheet.</div>`;
          renderSheetSections();
          return;
        }

        // Render search as cards in Recommended area; keep newGrid intact
        gridRec.innerHTML = "";
        data.result.forEach(item => {
          const movie = {
            title: item.title || "Untitled",
            year: "",
            language: "",
            genre: "",
            rating: "",
            poster: item.thumbs || item.thumbnail || "",
            embed: `https://doodstream.com/e/${item.file_code || ""}`
          };
          const card = buildCard(movie, false);
          gridRec.appendChild(card);
        });

      }catch(err){
        console.error("Doodstream search error", err);
        gridRec.innerHTML = `<div class="chip">Search failed. Showing recommended from Google Sheet.</div>`;
        renderSheetSections();
      }
    }

    qs("#searchBtn").addEventListener("click", ()=>{
      const q = qs("#globalSearch").value.trim();
      if(q) searchDoodstream(q);
    });
    qs("#globalSearch").addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        const q = e.target.value.trim();
        if(q) searchDoodstream(q);
      }
    });

    /* ====== IMDb Poster via TMDb ====== */
    async function fetchPosterByIMDb(imdbIdRaw){
      const imdbId = imdbIdRaw.trim();
      const posterBox = qs("#imdbPoster");
      const titleBox = qs("#imdbTitle");
      const imdbLink = qs("#imdbLink");
      const tmdbLink = qs("#tmdbLink");

      // Reset UI to skeleton
      posterBox.className = "skeleton";
      posterBox.innerHTML = "";
      titleBox.textContent = "";
      imdbLink.style.opacity = ".0"; imdbLink.style.pointerEvents = "none";
      tmdbLink.style.opacity = ".0"; tmdbLink.style.pointerEvents = "none";

      if(!imdbId || !/^tt\d{5,}$/.test(imdbId)){
        titleBox.textContent = "Please enter a valid IMDb ID (e.g., tt4154796).";
        return;
      }

      try{
        const url = `https://api.themoviedb.org/3/find/${encodeURIComponent(imdbId)}?api_key=${encodeURIComponent(CONFIG.TMDB_API_KEY)}&external_source=imdb_id`;
        const res = await fetch(url, {cache:"no-store"});
        const data = await res.json();

        const item = (data.movie_results && data.movie_results[0]) || (data.tv_results && data.tv_results[0]) || null;
        if(!item){
          titleBox.textContent = "No TMDb match found for that IMDb ID.";
          posterBox.className = "skeleton";
          return;
        }
        const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : "";
        const img = create("img", {src:posterUrl, alt:item.title || item.name || "Poster", loading:"lazy"});
        posterBox.className = "";
        posterBox.appendChild(img);

        const name = item.title || item.name || "Untitled";
        titleBox.textContent = name;

        imdbLink.href = `https://www.imdb.com/title/${imdbId}/`;
        tmdbLink.href = `https://www.themoviedb.org/${item.media_type || "movie"}/${item.id}`;
        imdbLink.style.opacity = "1"; imdbLink.style.pointerEvents = "auto";
        tmdbLink.style.opacity = "1"; tmdbLink.style.pointerEvents = "auto";

      }catch(err){
        console.error("TMDb fetch error", err);
        titleBox.textContent = "Error fetching poster. Please try again.";
        posterBox.className = "skeleton";
      }
    }
    qs("#imdbFetchBtn").addEventListener("click", ()=>{
      const id = qs("#imdbIdInput").value;
      fetchPosterByIMDb(id);
    });

    /* ====== Popup System (once per day) ====== */
    function shouldShowPopup(){
      const last = localStorage.getItem("tg_popup_last");
      if(!last) return true;
      try{
        const when = Number(last);
        const now = Date.now();
        const oneDay = 24*60*60*1000;
        return (now - when) > oneDay;
      }catch{ return true; }
    }
    function showPopup(){
      const modal = qs("#popupModal");
      modal.classList.add("active");
      localStorage.setItem("tg_popup_last", String(Date.now()));
      // Auto-close in 10s
      const t = setTimeout(()=> hidePopup(), 10000);
      // Dismiss button
      qs("#dismissModal").onclick = ()=>{ clearTimeout(t); hidePopup(); };
    }
    function hidePopup(){
      qs("#popupModal").classList.remove("active");
    }

    // Bookmark instructions (programmatic bookmarking isnâ€™t supported reliably)
    qs("#bookmarkSite").addEventListener("click", ()=>{
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const msg = isMac ? "Press Command + D to bookmark this site." : "Press Ctrl + D to bookmark this site.";
      showPopup(); // keep modal visible to show message
      alert(msg);
      hidePopup();
    });

    // PWA install prompt
    window.addEventListener("beforeinstallprompt", (e)=>{
      e.preventDefault();
      state.deferredPrompt = e;
    });
    qs("#installPWA").addEventListener("click", async ()=>{
      if(state.deferredPrompt){
        state.deferredPrompt.prompt();
        const choice = await state.deferredPrompt.userChoice;
        state.deferredPrompt = null;
      }else{
        alert("Install prompt not available. Try using Chrome on Android and visit again.");
      }
    });

    /* ====== Request section actions ====== */
    qs("#copyFormat").addEventListener("click", async ()=>{
      const text = qs("#requestFormat").value;
      try{
        await navigator.clipboard.writeText(text);
        showToast("âœ… Request format copied!");
      }catch{
        showToast("Copied. If not, please copy manually.");
      }
    });
    qs("#tgBtn").href = CONFIG.TELEGRAM_GROUP_URL;

    /* ====== Init ====== */
    window.addEventListener("DOMContentLoaded", ()=>{
      fetchSheetMovies();
      if(shouldShowPopup()) showPopup();
    });
  </script>

  <!-- Optional: Basic manifest for Add to Home Screen (replace icons with your files) -->
  <link rel="manifest" href="manifest.json" />
</body>
</html>
